{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} - Omniferous{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'store:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'store:product_list' %}">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ category.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-12">
            <div class="category-header mb-4">
                <h1>{{ category.name }}</h1>
                {% if category.description %}
                <p class="text-muted">{{ category.description }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% if products %}
    <div id="category-product-grid-ajax-container">
        {% include 'store/_product_grid.html' %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-box-open fa-4x text-muted mb-4"></i>
        <h3>No products in this category</h3>
        <p class="text-muted mb-4">Check back later for new products in this category.</p>
        <a href="{% url 'store:product_list' %}" class="btn btn-primary">Browse All Products</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function applyCategoryFilters(url) {
            // Add a loading indicator
            $('#category-product-grid-ajax-container').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');

            $.ajax({
                url: url,
                type: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                success: function(response) {
                    $('#category-product-grid-ajax-container').html(response.html);
                    // Update the product count. Assuming the count is near the h1 tag
                    $('.text-muted:contains("products found")').text(`${response.count} products found`);
                    history.pushState(null, '', url); // Update URL without full reload

                    // Re-attach AJAX event for new 'Add to Cart' forms
                    attachAddToCartForms();
                },
                error: function(xhr, status, error) {
                    console.error("Category Filter AJAX Error:", status, error);
                    $('#category-product-grid-ajax-container').html('<div class="alert alert-danger">Error loading products. Please try again.</div>');
                }
            });
        }

        // Function to attach AJAX event listeners to 'Add to Cart' forms
        function attachAddToCartForms() {
            $('form.ajax-add-to-cart-form').off('submit').on('submit', function(e) {
                e.preventDefault();
                var form = $(this);
                var addCartUrl = form.attr('action');
                var method = form.attr('method');
                var formData = form.serialize();

                $.ajax({
                    url: addCartUrl,
                    method: method,
                    data: formData,
                    success: function(addCartResponse) {
                        if (addCartResponse.success) {
                            $('.navbar-nav .badge.bg-danger').text(addCartResponse.cart_count);
                        } else {
                            displayAjaxMessage(addCartResponse.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        displayAjaxMessage('An error occurred. Please try again.', 'danger');
                        console.error("AJAX Add to Cart Error:", status, error);
                    }
                });
            });
        }

        // Intercept pagination clicks
        $(document).on('click', '#category-product-grid-ajax-container .pagination a.page-link', function(e) {
            e.preventDefault();
            var url = $(this).attr('href');
            applyCategoryFilters(url);
        });

        // Initial attachment of add to cart forms on page load
        attachAddToCartForms();

    });
</script>
{% endblock %}
